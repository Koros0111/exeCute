#! /bin/bash
set -e

cache="${HOME}/.cache/exeCute"
outputCache="${cache}/output"


mainFunction () {
	mime="$(file --brief --mime-type "${file}")"

	if fileIsDosProgram "${file}" "${mime}"; then
		launchDosProgram "${file}"
	elif fileIsWindowsProgram "${mime}"; then
		launchWindowsProgram "${file}"
	else
		echo "Not an exe or a bat: ${file}" >&2
		exit 1
	fi
}


checkFileExist () {
	if [[ ! -f "${file}" ]]; then
		echo "File doesn't exist: ${file}" >&2
		exit 1
	fi
}


checkFileNotEmpty () {
	if [[ -z "${file}" ]]; then
		echo "No file specified" >&2
		echo "Either type: exeCute \"pathToYourExeFile\""
		echo "Or just open with exeCute from the file manager"
		exit 1
	fi
}


cleanupWineEnvironment () {
	so rm --recursive --force "${cache}"
	restoreScreenConfig
	so killall fluidsynth
}


currentResolution () {
	xdpyinfo |
	grep dimensions |
	cut --delimiter=' ' --fields=7
}


desktopsLine () {
	local userReg="${1}"

	local line; line="$(
		grep --line-number "Desktops" "${userReg}" |
		cut --delimiter=':' --fields=1
	)"

	if [[ -n "${line}" ]]; then
		line="$((line + 2))"
		echo "${line}"
	fi
}


fileIsDosProgram () {
	local file="${1}"
	local mime="${2}"

	local lowercaseName; lowercaseName="${file,,}"
	local type; type="$(file --brief "${file}")"
	local group; group="$(echo "${mime}" | cut --delimiter='/' --fields=1)"

	hasSubstring "${type}" "MS-DOS executable" &&
	! hasSubstring "${type}" "Windows" ||
	[[ "${group}" == "text" && "${lowercaseName: -4}" == ".bat" ]]
}


fileIsWindowsProgram () {
	local mime="${1}"

	[[ "${mime}" == "application/vnd.microsoft.portable-executable" ]] ||
	[[ "${mime}" == "application/x-ms-ne-executable" ]]
}


hasSubstring () {
	local string="${1}"
	local substring="${2}"

	echo "${string}" | grep --quiet "${substring}"
}


isos () {
	find . -type f \
		\( \
			-iname "*.iso" -or \
			-iname "*.cue" -or \
			-iname "*.gog" \
		\) |
	sort |
	xargs
}


launchDosProgram () {
	local file="${1}"

	so dosbox -c "$(mounts)" "${file}" -fullscreen -exit
}


launchWindowsProgram () {
	local program="${1}"

	notify-send "Launching $(basename "${file}")" --icon="exeCute" --expire-time="10000"
	prepareWineEnvironment

	if ! wine "${program}" &> "${outputCache}"; then
		cat "${outputCache}" >&2
		exit 1
	fi
}


mounts () {
	isos="$(isos)"

	if [[ -z "${isos}" ]]; then
		echo "mount d . -t cdrom"
	else
		notifyDiskChangeShortcut "${isos}"
		echo "imgmount d ${isos} -t iso"
	fi
}


notifyDiskChangeShortcut () {
	readarray -t isoList < <(args "${@}")

	if [[ "${#isoList[@]}" -gt 1 ]]; then
		notify-send "For changing disk use: Ctrl+F4" --icon="gtk-cdrom" --expire-time="10000"
		sleep 10
	fi
}


prepareEnvironment () {
	readarray -t args < <(args "${@}")
	file="${args[*]}"

	checkFileNotEmpty
	checkFileExist
	cd "$(dirname "${file}")"
}


prepareWineEnvironment () {
	previousResolution="$(currentResolution)"

	trap "cleanupWineEnvironment" INT TERM QUIT ERR EXIT
	so mkdir --parents "${cache}"
	setDesktopResolution
	startSynth
	export WINEDEBUG=err+all,fixme-all,warn-all,trace-all
}


restoreScreenConfig () {
	so xrandr --size "${previousResolution}"
	so xgamma -gamma 1
}


setDesktopResolution () {
	local targetResolution; targetResolution="$(targetResolution)"

	if [[ -z "${targetResolution}" ]]; then
		setVirtualDesktopResolution ""
	elif ! xrandr | grep --quiet "${targetResolution}"; then
		echo "desktop.conf: Unsupported resolution: ${targetResolution}" >&2
	else
		setVirtualDesktopResolution "${targetResolution}"
		so xrandr --size "${targetResolution}"
	fi
}


setVirtualDesktopResolution () {
	local targetResolution="${1}"
	local userReg="${HOME}/.wine/user.reg"

	if [[ ! -f "${userReg}" ]]; then
		wine - &> /dev/null || true
	fi

	local line; line="$(desktopsLine "${userReg}")"

	if [[ -z "${line}" ]]; then
		# shellcheck disable=SC2129
		echo '[Software\\Wine\\Explorer\\Desktops] 1635388843' >> "${userReg}"
		echo '#time=1d7cba5344b505e' >> "${userReg}"
		# shellcheck disable=SC2086
		echo '"Default"="'${targetResolution}'"' >> "${userReg}"
	else
		sed --in-place "${line}s/.*/\"Default\"=\"${targetResolution}\"\n/" "${userReg}"
	fi
}


so () {
	/bin/so "-${FUNCNAME[1]}" "${@}"
}


startSynth () {
	if ! userProcessIsRunning "$USER" "fluidsynth"; then
		fluidsynth -si -a alsa -m alsa_seq -C no -g 0.5 -L 1 -r 48000 -R yes -z 1024 \
			-o synth.default-soundfont="/usr/share/soundfonts/GeneralUser.sf2" &> /dev/null &
	fi
}


targetResolution () {
	local fileDir; fileDir="$(dirname "${file}")"
	local conf="${fileDir}/desktop.conf"
	local targetResolution=""

	if [[ -f "${conf}" ]]; then
		targetResolution="$(cat "${conf}")"

		if [[ -z "${targetResolution}" ]]; then
			targetResolution="$(currentResolution)"
		fi
	fi

	echo "${targetResolution}"
}


userProcessIsRunning () {
	local user="${1}"
	local process="${2}"

	pgrep -u "${user}" |
	grep --quiet "${process}"
}


prepareEnvironment "${@}"
mainFunction
